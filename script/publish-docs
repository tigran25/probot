#!/bin/sh

set -e

# Store the versions
VERSION=$(npm view probot version)

# Generate docs
npm run doc

# Checkout the website into the tmp directory
[ -d tmp/website ] || {
  mkdir -p tmp
  git clone https://github.com/probot/probot.github.io tmp/website
}

# Update the website checkout
cd tmp/website
git pull origin master

# Delete previously generated docs for this version
rm -rf api/$VERSION

# Copy over the new docs
mv ../../out/probot/$VERSION api/$VERSION

ln -sfn $VERSION api/latest

# Commit and publish
git add .
git commit -m "Update docs for v$VERSION"
git tag v$VERSION
git push --tags origin master
